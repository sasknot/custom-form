/*!*
 * jQuery Plugin: Custom Form Integration
 *
 *  @package    JS Plugins
 *  @category   jquery plugin
 *  @author     Rafael F. Silva <rafaelfsilva1@gmail.com>
 *  @link       /js/plugins/jquery.custom-form.js
 *  @since      14/01/2014
 *  @version    1.0.54
 *
 *  This plugin require other plugins to certain features work, like:
 *  custom select (select2), mask (maskedinput) and monetization (maskMoney).
 *
**/
!function(t){"use strict";var e={settings:{},_setSettings:function(e,s){var a=t.extend({},t.fn.customForm.defaults,s);return"string"==typeof a.errorContainer&&(a.errorContainer=t(e).find(a.errorContainer)),a.dateFormat=a.dateFormat.toLowerCase(),a.dateRegExp=new RegExp("(("+a.dateFormat.replace("dd","(0[1-9]|[12][0-9]|3[01])").replace("mm","(0[13578]|1[02])").replace("yyyy","((1[0-9]|[2-9][0-9])[0-9]{2})").replace("yy","([0-9]{2})")+")|("+a.dateFormat.replace("dd","(0[1-9]|[12][0-9]|30)").replace("mm","(0[13456789]|1[012])").replace("yyyy","((1[0-9]|[2-9][0-9])[0-9]{2})").replace("yy","([0-9]{2})")+")|("+a.dateFormat.replace("dd","(0[1-9]|1[0-9]|2[0-8])").replace("mm","02").replace("yyyy","((1[0-9]|[2-9][0-9])[0-9]{2})").replace("yy","([0-9]{2})")+")|("+a.dateFormat.replace("dd","29").replace("mm","02").replace("yyyy","((1[6-9]|[2-9][0-9])(0[48]|[2468][048]|[13579][26])|((16|[2468][048]|[3579][26])00))").replace("yy","(0[048]|[2468][048]|[13579][26])")+"))","g"),a.timeFormat=a.timeFormat.toLowerCase(),a.timeRegExp=new RegExp(a.timeFormat.replace("hh","([01][0-9]|2[0-3])").replace(/mm|ss/g,"[0-5][0-9]"),"g"),t(e).data("settings",a),a},init:function(e,s){var a=t(e),i=this._setSettings(e,s);this.settings=i,t(e).data("is-valid",!1),this.mask(e),t.fn.select2&&a.find('.field select[class*="select2"]').each(function(){var e=t(this).data("options")||{};t(this).hasClass("select2-no-search")&&(e.minimumResultsForSearch=-1),t(this).hasClass("select2-tags")&&(e.tags=[]),t(this).hasClass("select2-unique-selection")&&(e.allowClear=!0,t(this).on("select2-selecting",function(e){var s=t(this).find('option[value="'+e.val+'"]').data("unique-key");t(this).find('option[data-unique="'+s+'"]').not('option[value="'+e.val+'"]').attr("disabled","disabled")}).on("select2-removed",function(e){var s=t(this).find('option[value="'+e.val+'"]').data("unique-key");t(this).find('option[data-unique="'+s+'"]').removeAttr("disabled")}));var s=t.extend({placeholder:!0,adaptContainerCssClass:function(){return""},containerCssClass:"select2-custom",dropdownCssClass:"select2-custom"},e);t(this).select2(s)}),a.find(".field.state select, .field.target select").change(function(){var e=t(t(this).data("target")),s=t(this).data("request-url");if(e&&s&&""!==t(this).val()){for(var a=e.attr("placeholder")||e.data("placeholder"),i=[t(this).val()],l=this;t('[data-target="#'+l.id+'"]').length>0;)l=t('[data-target="#'+l.id+'"]').get(0),i.unshift(t(l).val());t.ajax({url:s+i.join("/"),dataType:"json",beforeSend:function(){e.html('<option value=""></option>').attr("placeholder","Carregando..."),t.fn.select2&&e.select2("val","")},success:function(s){var i='<option value=""></option>';t.each(s,function(t,e){i+='<option value="'+t+'">'+e+"</option>"}),e.html(i),e.attr("placeholder")?e.attr("placeholder",a):e.data("placeholder",a),e.data("initial-value")&&e.val(e.data("initial-value")),t.fn.select2&&(e.select2("val","").select2("close"),e.data("initial-value")&&e.select2("val",e.data("initial-value")));for(var l=e;l.closest(".field").hasClass("target");)l=t(l.data("target")),l.html('<option value=""></option>'),t.fn.select2&&l.select2("val","").select2("close")}})}}).on("select2-clearing",function(){var e=t(t(this).data("target"));e.html('<option value=""></option>').select2("val","").select2("close");for(var s=e;s.closest(".field").hasClass("target");)s=t(s.data("target")),s.html('<option value=""></option>'),t.fn.select2&&s.select2("val","").select2("close")}),a.on("submit",function(e){t(this).customForm("validate",{success:function(e){var s=t(this),a=t(e);s.find('input[type="submit"]').attr("disabled",!0),a.find(".sending").show(),s.hasClass("ajaxForm")&&t.ajax({url:this.action,type:this.method||"POST",data:s.serialize(),dataType:"json",beforeSend:function(){a.find(".return").removeClass("success error").html("")},success:function(e){a.find("p").hide(),e?(e.message&&a.find(".return").addClass(e.error?"error":"success").html(e.message).show(),(e.url||e.redirect)&&(window.location.href=e.url||e.redirect),e.data&&s.trigger("ajax-callback",e.data),e.error===!1&&e.clear&&(s.find('input[type="text"], input[type="password"], input[type="email"], input[type="date"], input[type="file"], select:not(.select2), textarea').val(""),s.find('input[type="checkbox"], input[type="radio"]').attr("checked",!1).parent().removeClass("selected"),t.fn.select2&&s.find('select[class*="select2"]').select2("val","",!0),s.find(".field[data-initial-classes]").each(function(){t(this).removeClass().addClass(t(this).data("initial-classes"))}))):a.find(".sendError").show().find("span").text("null")},error:function(t,e){a.find("p").hide(),a.find(".sendError").show().find("span").text(e)},complete:function(){s.find('input[type="submit"]').removeAttr("disabled")}})}}),(t(this).hasClass("ajaxForm")||!t(this).data("is-valid"))&&e.preventDefault()})},validate:function(e,s){var a=t(e).data("settings")||this._setSettings(e,s.options||{}),i=a.errorContainer,l=!1,n="."+a.requiredClass+":not([disabled])",r=t(e).find("input, select, textarea").filter(n);a.ignoreInvisible&&(r=r.closest(".field").filter(":visible").find("input, select, textarea").filter(":visible").filter(n)),a.dateRegExp.lastIndex=0,a.timeRegExp.lastIndex=0,r.each(function(){"INPUT"==this.tagName&&("text"==this.type||"password"==this.type)&&""===this.value&&t(this).closest(".field").hasClass("depends")===!1&&t(this).closest(".field").hasClass("dependsNot")===!1||"INPUT"==this.tagName&&"file"==this.type&&(""===this.value||t(this).closest(".field").hasClass(a.errorClass))||"INPUT"==this.tagName&&"text"==this.type&&t(this).closest(".field").hasClass("date")&&(""===this.value||!a.dateRegExp.test(this.value))||"INPUT"==this.tagName&&t(this).closest(".field").hasClass("time")&&(""===this.value||!a.timeRegExp.test(this.value))||"INPUT"==this.tagName&&("text"==this.type||"email"==this.type)&&t(this).closest(".field").hasClass("email")&&(""===this.value||!/^[a-zA-Z0-9][a-zA-Z0-9\._-]+@([a-zA-Z0-9\._-]+\.)[a-zA-Z-0-9]{2}/.test(this.value))||"INPUT"==this.tagName&&("text"==this.type||"url"==this.type)&&t(this).closest(".field").hasClass("url")&&(""===this.value||!/(http:\/\/)?(www)([a-zA-Z0-9\._-]+\.)[a-zA-Z-0-9]{2,3}/.test(this.value))||"INPUT"==this.tagName&&t(this).closest(".field").hasClass("cpf")&&(""===this.value||!function(t){var e,s,a,i,l,n;if(t=t.replace(/[^0-9]/g,""),n=1,t.length<11)return!1;for(i=0;i<t.length-1;i++)if(t.charAt(i)!=t.charAt(i+1)){n=0;break}if(n)return!1;for(e=t.substring(0,9),s=t.substring(9),a=0,i=10;i>1;i--)a+=e.charAt(10-i)*i;if(l=2>a%11?0:11-a%11,l!=s.charAt(0))return!1;for(e=t.substring(0,10),a=0,i=11;i>1;i--)a+=e.charAt(11-i)*i;return l=2>a%11?0:11-a%11,l!=s.charAt(1)?!1:!0}(this.value))||t(this).closest(".field").hasClass("equalsTo")&&(0===t(this).val().length||t(this).val()!=t(t(this).data("equals-to")).val())||t(this).closest(".field").hasClass("depends")&&t(t(this).data("depends")).is(":checked")&&0===t(this).val().length||t(this).closest(".field").hasClass("dependsNot")&&t(t(this).data("depends")).is(":checked")===!1&&0===t(this).val().length||"INPUT"==this.tagName&&"checkbox"==this.type&&this.checked===!1||"INPUT"==this.tagName&&"radio"==this.type&&0===t(this).closest("form").find('[name="'+this.name+'"]:checked').length||"TEXTAREA"==this.tagName&&""===t(this).val()||"SELECT"==this.tagName&&(void 0===t(this).val()||null===t(this).val()||""===t(this).val()||t(this).val().length&&0===t(this).val().length)&&t(this).closest(".field").hasClass("depends")===!1&&t(this).closest(".field").hasClass("dependsNot")===!1?(l=!0,t(this).closest(".field").addClass(a.errorClass)):t(this).closest(".field").removeClass(a.errorClass)}),i.find("p").hide(),l?(t(e).data("is-valid",!1),i.find(".invalid").show()):(t(e).data("is-valid",!0),s.success&&s.success.apply(e,i))},mask:function(e){{var s=t(e);this.settings}if(t.fn.mask&&(s.find('.field.date input[type="text"]').mask(this.settings.dateFormat.replace(/[dmy]/g,"9")),s.find('.field.time input[type="text"]').mask(this.settings.timeFormat.replace(/[hms]/g,"9")),s.find('.field.phone input[type="text"]').mask("99 99999999?9"),s.find('.field.cpf input[type="text"]').mask("999.999.999-99"),s.find('.field.cnpj input[type="text"]').mask("99.999.999/9999-99"),s.find('.field.cep input[type="text"]').mask("99999-999"),s.find('.field.carPlate input[type="text"]').mask("aaa-9999")),t.fn.maskMoney){var a={symbol:"R$",showSymbol:!0,symbolStay:!0,thousands:".",decimal:",",precision:2,defaultZero:!0,allowZero:!1,allowNegative:!1};s.find('.field.money input[type="text"]').each(function(){var e=t.extend(a,t(this).data("options")||{});t(this).maskMoney(e)}),s.find('.field.float input[type="text"]').each(function(){var e=t.extend(a,{symbol:"",thousands:""});t(this).maskMoney(e)})}},destroy:function(e){t(e).data("settings",!1),t(e).off("submit")}};t.fn.customForm=function(s){if(e[s]){var a="object"==typeof arguments[1]?arguments[1]:{};return this.each(function(){e[s].call(e,this,a)})}return"object"!=typeof s&&s?void t.error("Method "+s+" does not exist on jQuery customForm"):this.each(function(){e.init.call(e,this,s)})},t.fn.customForm.defaults={requiredClass:"required",errorClass:"error",errorContainer:".messages",ignoreInvisible:!0,dateFormat:"dd/mm/yyyy",timeFormat:"hh:mm:ss"}}(jQuery);